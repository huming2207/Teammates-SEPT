<div class="panel panel-default panel-body" data-is-session-open="${isSessionOpen}"
     name="${Const.ParamsNames.FEEDBACK_RESPONSE_FILE}-${questionIndex}-${responseIndex}">
    <form method="post" id="${Const.ParamsNames.FEEDBACK_RESPONSE_FILE}-${questionIndex}-${responseIndex}">
        <input type="file" name="document">
        <input type="submit" title="Submit" name="submit">
    </form>
</div>
<script>
    $(document).ready(function(){
        let fileForm = $(`#${Const.ParamsNames.FEEDBACK_RESPONSE_FILE}-${questionIndex}-${responseIndex}`);
        fileForm.submit(function(event) {
            event.preventDefault();
            const formData = new FormData($(fileForm)[0]);

            $.ajax({
                type: 'POST',
                url: `/page/createDocUploadUrl`,
                error() {
                    console.log('URL request failed, please try again.');
                },
                success(data) {
                    setTimeout(() => {
                        if (data.isError) {
                            console.log(data.ajaxStatus);
                        } else {
                            fileForm.attr('action', data.nextUploadUrl);
                            console.log(fileForm, formData);
                        }
                    }, 5000);
                }
            });
        });
    });

    function performDocPost(fileForm, formData) {
        $.ajax({
            type: 'POST',
            enctype: 'multipart/form-data',
            url: fileForm.attr('action'),
            data: formData,
            // Options to tell jQuery not to process data or worry about content-type.
            cache: false,
            contentType: false,
            processData: false,
            error() {
                console.log('Document upload failed, please try again.');
            },
            success(data) {
                setTimeout(() => {
                    if (data.isError) {
                        setErrorMessage(data.ajaxStatus);
                    } else if (data.isFileUploaded) {
                        console.log(data.fileSrcUrl);
                        console.log(data.ajaxStatus);
                    } else {
                        console.log(data.ajaxStatus);
                    }
                }, 500);

                replaceFormElements(data.fileSrcUrl);
            }
        });
    }

    // Remove the form and replace with the URL
    function replaceFormElements(fileSrcUrl) {
        let mainDiv = $(`div[name="${Const.ParamsNames.FEEDBACK_RESPONSE_FILE}-${questionIndex}-${responseIndex}"]`);

        // Sayonara to the form lol
        mainDiv.remove("form");

        // Put ID back to the main "div" section for further processing
        mainDiv.attr("id", `#${Const.ParamsNames.FEEDBACK_RESPONSE_FILE}-${questionIndex}-${responseIndex}`);

        // Fill in the div section
        mainDiv.html(fileSrcUrl);
    }
</script>